name: focus-timer pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  IMAGE_NAME: focus-timer
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  OIDC_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN_OIDC }}
  DEPLOYMENT_NAME: focus-deployment
  CONTAINER_NAME: focus-timer
  K8S_NAMESPACE: dev
  DEPLOYMENT_FILE_PATH: ./focus-timer-app/focus-deployment.yaml   # adjust if your file is elsewhere

jobs:
  build-scan-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. AWS OIDC Authentication
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. Create ECR repository if missing
      - name: Create ECR repository
        uses: int128/create-ecr-repository-action@v1
        with:
          repository: ${{ env.IMAGE_NAME }}
          region: ${{ env.AWS_REGION }}

      # 4. Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 5. Build Docker image tagged with commit SHA
      - name: Build Docker image
        run: |
          echo "Using commit SHA: $GITHUB_SHA"
          docker build -t $ECR_REGISTRY/$IMAGE_NAME:$GITHUB_SHA ./focus-timer-app
          docker tag $ECR_REGISTRY/$IMAGE_NAME:$GITHUB_SHA $ECR_REGISTRY/$IMAGE_NAME:latest

      # 6. Trivy Security Scan
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: $ECR_REGISTRY/$IMAGE_NAME:$GITHUB_SHA
          severity: CRITICAL,HIGH
          exit-code: 1
          ignore-unfixed: true

      # 7. Push Docker image to ECR
      - name: Push Docker image
        run: |
          docker push $ECR_REGISTRY/$IMAGE_NAME:$GITHUB_SHA
          docker push $ECR_REGISTRY/$IMAGE_NAME:latest

      # 8. Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

      # 9. Ensure namespace exists
      - name: Ensure namespace exists
        run: |
          kubectl get namespace $K8S_NAMESPACE || kubectl create namespace $K8S_NAMESPACE

      # 10. Deploy to EKS: replace IMAGE_PLACEHOLDER with SHA-tagged image
      - name: Deploy to EKS
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$ECR_REGISTRY/$IMAGE_NAME:$GITHUB_SHA|g" $DEPLOYMENT_FILE_PATH
          kubectl apply -f $DEPLOYMENT_FILE_PATH

      # 11. Verify rollout
      - name: Verify rollout status
        run: |
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $K8S_NAMESPACE
