name: journal pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  IMAGE_NAME: journal
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  OIDC_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN_OIDC }}
  DEPLOYMENT_NAME: journal-deployment
  CONTAINER_NAME: journal
  K8S_NAMESPACE: dev

jobs:
  build-scan-push-deploy:
    runs-on: ubuntu-latest

    steps:

      # ---------------------------
      # 1. Checkout source
      # ---------------------------
      - name: Checkout source
        uses: actions/checkout@v4

      # ---------------------------
      # 2. AWS OIDC Authentication
      # ---------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------
      # 3. Configure EKS Access (SAFE - optional)
      # ---------------------------
      - name: Create EKS access entry (if not exists)
        run: |
          aws eks create-access-entry \
            --cluster-name $EKS_CLUSTER_NAME \
            --principal-arn $OIDC_ROLE_ARN \
            --type STANDARD || echo "Access entry exists"

      - name: Associate EKS access policy (if not exists)
        run: |
          aws eks associate-access-policy \
            --cluster-name $EKS_CLUSTER_NAME \
            --principal-arn $OIDC_ROLE_ARN \
            --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
            --access-scope type=cluster || echo "Policy exists"

      # ---------------------------
      # 4. Create ECR repository
      # ---------------------------
      - name: Create ECR repository if needed
        uses: int128/create-ecr-repository-action@v1
        with:
          repository: ${{ env.IMAGE_NAME }}
          region: ${{ env.AWS_REGION }}

      # ---------------------------
      # 5. Login to Amazon ECR
      # ---------------------------
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ---------------------------
      # 6. Build Docker Image
      # ---------------------------
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./study-journal-app
          push: false
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}

      # ---------------------------
      # 7. Trivy Security Scan
      # ---------------------------
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
          severity: CRITICAL,HIGH
          exit-code: 0
          ignore-unfixed: true

      # ---------------------------
      # 8. Push Docker Image
      # ---------------------------
      - name: Push image to Amazon ECR
        uses: docker/build-push-action@v5
        with:
          context: ./study-journal-app
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
            ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      # ---------------------------
      # 9. Update kubeconfig
      # ---------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER_NAME

      # ---------------------------
      # 10. Ensure namespace exists (FIX)
      # ---------------------------
      - name: Ensure namespace exists
        run: |
          kubectl get namespace $K8S_NAMESPACE || kubectl create namespace $K8S_NAMESPACE

      # ---------------------------
      # 11. Deploy to EKS
      # ---------------------------
      - name: Deploy to EKS
        run: |
          kubectl set image deployment/$DEPLOYMENT_NAME \
          $CONTAINER_NAME=$ECR_REGISTRY/$IMAGE_NAME:${{ github.run_number }} \
          -n $K8S_NAMESPACE

      # ---------------------------
      # 12. Verify rollout
      # ---------------------------
      - name: Verify rollout status
        run: |
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $K8S_NAMESPACE
